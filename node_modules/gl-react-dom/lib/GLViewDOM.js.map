{"version":3,"file":"GLViewDOM.js","names":["__DEV__","process","env","NODE_ENV","propTypes","onContextCreate","PropTypes","func","isRequired","onContextFailure","onContextLost","onContextRestored","webglContextAttributes","object","width","number","height","style","pixelRatio","version","string","ErrorDebug","Component","render","error","props","title","String","rawError","message","detail","longMessage","position","top","left","padding","background","color","fontSize","lineHeight","fontStyle","fontWeight","fontFamily","overflow","titleStyle","marginBottom","detailStyle","whiteSpace","GLViewDOM","e","preventDefault","gl","_createContext","ref","canvas","setState","state","componentDidMount","invariant","addEventListener","_onContextLost","_onContextRestored","Error","componentWillUnmount","loseGL","removeEventListener","debug","rest","Number","window","devicePixelRatio","k","hasOwnProperty","display","onRef","getContext","preserveDrawingBuffer","captureAsDataURL","args","console","warn","toDataURL","captureAsBlob","Promise","resolve","then","reject","toBlob"],"sources":["../src/GLViewDOM.js"],"sourcesContent":["//@flow\nimport React, { Component } from \"react\";\nimport PropTypes from \"prop-types\";\nimport invariant from \"invariant\";\nimport getContext from \"./getContext\";\nimport loseGL from \"./loseGL\";\n\nconst __DEV__ = process.env.NODE_ENV === \"development\";\n\n/**\n * WebGL context initial options.\n */\ntype WebGLContextAttributes = {\n  alpha?: boolean,\n  depth?: boolean,\n  stencil?: boolean,\n  antialias?: boolean,\n  premultipliedAlpha?: boolean,\n  preserveDrawingBuffer?: boolean,\n  preferLowPowerToHighPerformance?: boolean,\n  failIfMajorPerformanceCaveat?: boolean,\n};\n\nconst propTypes = {\n  onContextCreate: PropTypes.func.isRequired,\n  onContextFailure: PropTypes.func.isRequired,\n  onContextLost: PropTypes.func.isRequired,\n  onContextRestored: PropTypes.func.isRequired,\n  webglContextAttributes: PropTypes.object,\n  width: PropTypes.number.isRequired,\n  height: PropTypes.number.isRequired,\n  style: PropTypes.object,\n  pixelRatio: PropTypes.number,\n  version: PropTypes.string,\n};\n\nclass ErrorDebug extends Component {\n  render() {\n    const { error } = this.props;\n    let title = String(error.rawError || error.message || error);\n    let detail = String(error.longMessage || error.rawError || \"\");\n    const style = {\n      width: \"100%\",\n      height: \"100%\",\n      position: \"absolute\",\n      top: 0,\n      left: 0,\n      padding: \"1em\",\n      background: \"#a00\",\n      color: \"#fff\",\n      fontSize: \"12px\",\n      lineHeight: \"1.2em\",\n      fontStyle: \"normal\",\n      fontWeight: \"normal\",\n      fontFamily: \"monospace\",\n      overflow: \"auto\",\n    };\n    const titleStyle = {\n      fontWeight: \"bold\",\n      marginBottom: \"1em\",\n    };\n    const detailStyle = {\n      whiteSpace: \"pre\",\n    };\n    return (\n      <div style={style}>\n        <div style={titleStyle}>{title}</div>\n        <div style={detailStyle}>{detail}</div>\n      </div>\n    );\n  }\n}\n\nexport default class GLViewDOM extends Component<\n  {\n    onContextCreate: (gl: WebGLRenderingContext) => void,\n    onContextFailure: (e: Error) => void,\n    onContextLost: () => void,\n    onContextRestored: (gl: ?WebGLRenderingContext) => void,\n    webglContextAttributes?: WebGLContextAttributes,\n    pixelRatio?: number,\n    width: number,\n    height: number,\n    style?: any,\n    debug?: number,\n    version?: string,\n  },\n  {\n    error: ?Error,\n  }\n> {\n  state = {\n    error: null,\n  };\n  static propTypes = propTypes;\n  webglContextAttributes: WebGLContextAttributes;\n  canvas: ?HTMLCanvasElement;\n  gl: ?WebGLRenderingContext;\n\n  componentDidMount() {\n    const { onContextCreate, onContextFailure } = this.props;\n    const gl: ?WebGLRenderingContext = this._createContext();\n    if (gl) {\n      this.gl = gl;\n      onContextCreate(gl);\n      const { canvas } = this;\n      invariant(canvas, \"canvas is not settled in GLViewDOM#componentDidMount\");\n      canvas.addEventListener(\"webglcontextlost\", this._onContextLost);\n      canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored);\n    } else {\n      onContextFailure(new Error(\"no-webgl-context\"));\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.gl) {\n      loseGL(this.gl);\n      this.gl = null;\n    }\n    const { canvas } = this;\n    if (canvas) {\n      canvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\n      canvas.removeEventListener(\n        \"webglcontextrestored\",\n        this._onContextRestored\n      );\n    }\n  }\n\n  render() {\n    const { error } = this.state;\n    let {\n      width,\n      height,\n      pixelRatio,\n      style,\n      debug,\n      version,\n      ...rest\n    } = this.props;\n    if (!pixelRatio)\n      pixelRatio = Number(\n        (typeof window === \"object\" && window.devicePixelRatio) || 1\n      );\n    for (let k in propTypes) {\n      if (rest.hasOwnProperty(k)) {\n        delete rest[k];\n      }\n    }\n    return (\n      <span\n        style={{\n          position: \"relative\",\n          ...style,\n          display: \"inline-block\",\n          width,\n          height,\n        }}\n      >\n        <canvas\n          ref={this.onRef}\n          style={{ width, height }}\n          width={width * pixelRatio}\n          height={height * pixelRatio}\n          {...rest}\n        />\n        {error ? <ErrorDebug error={error} /> : null}\n      </span>\n    );\n  }\n\n  _createContext() {\n    const { webglContextAttributes, debug, version } = this.props;\n    const gl: ?WebGLRenderingContext = getContext(\n      this.canvas,\n      debug\n        ? { ...webglContextAttributes, preserveDrawingBuffer: true }\n        : webglContextAttributes,\n      version || \"auto\"\n    );\n    this.webglContextAttributes = webglContextAttributes || {};\n    return gl;\n  }\n\n  _onContextLost = (e: Event) => {\n    e.preventDefault();\n    this.gl = null;\n    this.props.onContextLost();\n  };\n\n  _onContextRestored = () => {\n    this.gl = this._createContext();\n    this.props.onContextRestored(this.gl);\n  };\n\n  onRef = (ref: HTMLCanvasElement) => {\n    this.canvas = ref;\n  };\n\n  debugError = !__DEV__\n    ? null\n    : (error: Error) => {\n        this.setState({ error });\n      };\n\n  afterDraw = !__DEV__\n    ? null\n    : () => {\n        if (this.state.error) {\n          this.setState({ error: null });\n        }\n      };\n\n  captureAsDataURL(...args: any): string {\n    if (!this.webglContextAttributes.preserveDrawingBuffer) {\n      console.warn(\n        \"Surface#captureAsDataURL is likely to not work if you don't define webglContextAttributes={{ preserveDrawingBuffer: true }}\"\n      );\n    }\n    invariant(this.canvas, \"canvas is no longer available\");\n    return this.canvas.toDataURL(...args);\n  }\n\n  captureAsBlob(...args: any): Promise<Blob> {\n    if (!this.webglContextAttributes.preserveDrawingBuffer) {\n      console.warn(\n        \"Surface#captureAsBlob is likely to not work if you don't define webglContextAttributes={{ preserveDrawingBuffer: true }}\"\n      );\n    }\n    return Promise.resolve().then(\n      () =>\n        new Promise((resolve, reject) =>\n          this.canvas\n            ? this.canvas.toBlob(resolve, ...args)\n            : reject(new Error(\"canvas is no longer available\"))\n        )\n    );\n  }\n}\n"],"mappings":"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"}